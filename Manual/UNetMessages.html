<!DOCTYPE html><html class="no-js">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-MC35ML');
    </script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<meta property="og:title" content="Network Messages - Unity Manual">
<title>Network Messages - Unity Manual</title>
<meta name="description" content="In addition to the high level facilities of commands and RPC calls, it is also possible to send raw network messages.">
<meta property="og:description" content="In addition to the high level facilities of commands and RPC calls, it is also possible to send raw network messages.">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFiles/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script>
      var docs_type = 'Manual';
      var lang = 'zh_CN';
      var page = 'UNetMessages';
      if(!page) page = 'index';
      var version = '560';
      var docs_versions = [{version: '2019.1',version_string: '2019.1'},{version: '2018.3',version_string: '2018.3'},{version: '2018.2',version_string: '2018.2'},{version: '2018.1',version_string: '2018.1'},{version: '2017.4',version_string: '2017.4'},{version: '2017.3',version_string: '2017.3'},{version: '2017.2',version_string: '2017.2'},{version: '2017.1',version_string: '2017.1'},{version: '5.6',version_string: '560'},{version: '5.5',version_string: '550'},{version: '5.4',version_string: '540'},{version: '5.3',version_string: '530'},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MC35ML" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="http://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">Manual</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>5.6</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2019.1" href="/zh_CN/2019.1/Manual/UNetMessages.html">2019.1</a></li>
<li><a class="docs_version_url_2018.3" href="/zh_CN/2018.3/Manual/UNetMessages.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/zh_CN/2018.2/Manual/UNetMessages.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/zh_CN/2018.1/Manual/UNetMessages.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/zh_CN/2017.4/Manual/UNetMessages.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/zh_CN/2017.3/Manual/UNetMessages.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/zh_CN/2017.2/Manual/UNetMessages.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/zh_CN/2017.1/Manual/UNetMessages.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/zh_CN/560/Manual/UNetMessages.html">5.6</a></li>
<li><a class="docs_version_url_550" href="/zh_CN/550/Manual/UNetMessages.html">5.5</a></li>
<li><a class="docs_version_url_540" href="/zh_CN/540/Manual/UNetMessages.html">5.4</a></li>
<li><a class="docs_version_url_530" href="/zh_CN/530/Manual/UNetMessages.html">5.3</a></li>
</ul></div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">Manual</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">Scripting API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">Language:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/560/Documentation/Manual/UNetMessages.html">English</a></li>
<li><a data-lang="ja" href="/ja/560/Manual/UNetMessages.html">日本語</a></li>
<li><a data-lang="es" href="/es/560/Manual/UNetMessages.html">Español</a></li>
<li><a data-lang="kr" href="/kr/560/Manual/UNetMessages.html">한국어</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>Manual</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>5.6</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2019.1" href="/zh_CN/2019.1/Manual/UNetMessages.html">2019.1</a></li>
<li><a class="docs_version_url_2018.3" href="/zh_CN/2018.3/Manual/UNetMessages.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/zh_CN/2018.2/Manual/UNetMessages.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/zh_CN/2018.1/Manual/UNetMessages.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/zh_CN/2017.4/Manual/UNetMessages.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/zh_CN/2017.3/Manual/UNetMessages.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/zh_CN/2017.2/Manual/UNetMessages.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/zh_CN/2017.1/Manual/UNetMessages.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/zh_CN/560/Manual/UNetMessages.html">5.6</a></li>
<li><a class="docs_version_url_550" href="/zh_CN/550/Manual/UNetMessages.html">5.5</a></li>
<li><a class="docs_version_url_540" href="/zh_CN/540/Manual/UNetMessages.html">5.4</a></li>
<li><a class="docs_version_url_530" href="/zh_CN/530/Manual/UNetMessages.html">5.3</a></li>
</ul></div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual (5.6)</a></li>
<li><a href="UNet.html">多玩家和联网</a></li>
<li><a href="UNetOverview.html">Networking Overview</a></li>
<li><a href="UNetUsingHLAPI.html">The High Level API</a></li>
<li>Network Messages</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="NetworkBehaviourCallbacks.html"></a></span><div class="tip">NetworkBehaviour 回调</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UNetDiscovery.html"></a></span><div class="tip">Local Discovery</div>
</div>
</div></div>
<h1>Network Messages</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>In addition to the high level facilities of commands and RPC calls, it is also possible to send raw network messages.</p>

<p>There is a class called MessageBase that can be extended to make serializable network message classes. This class has serialization and deserialization functions that take writer and reader objects. Developers can implement these functions themselves, or rely on code-generated implementations that are automatically created by the networking system. The base class looks like this:</p>

<pre><code>public abstract class MessageBase
{
    // De-serialize the contents of the reader into this message
    public virtual void Deserialize(NetworkReader reader) {}

    // Serialize the contents of this message into the writer
    public virtual void Serialize(NetworkWriter writer) {}
}
</code></pre>

<p>Message classes can contain members that are basic types, structs, arrays, and most of the common Unity Engine types such as Vector3. They cannot contain members that are complex classes or generic containers.</p>

<p>有一些内置消息类用于常见类型的网络消息：</p>

<ul>
<li>EmptyMessage</li>
<li>StringMessage</li>
<li>IntegerMessage</li>
</ul>

<p>To send a message there are Send() functions on the NetworkClient, NetworkServer, and NetworkConnection classes which work the same way. They take a message Id, and a message object that is derived from MessageBase. The code below shows how to send and handle a message using one of the built-in message classes:</p>

<pre><code>using UnityEngine;
using UnityEngine.Networking;
using UnityEngine.Networking.NetworkSystem;

public class Begin : NetworkBehaviour
{
    const short MyBeginMsg = 1002;

    NetworkClient m_client;

    public void SendReadyToBeginMessage(int myId)
    {
        var msg = new IntegerMessage(myId);
        m_client.Send(MyBeginMsg, msg);
    }

    public void Init(NetworkClient client)
    {
        m_client = client;
        NetworkServer.RegisterHandler(MyBeginMsg, OnServerReadyToBeginMessage);
    }

    void OnServerReadyToBeginMessage(NetworkMessage netMsg)
    {
        var beginMessage = netMsg.ReadMessage&lt;IntegerMessage&gt;();
        Debug.Log("received OnServerReadyToBeginMessage " + beginMessage.value);
    }
}
</code></pre>

<p>声明一个自定义网络消息类并使用该类：</p>

<pre><code>using UnityEngine;
using UnityEngine.Networking;

public class Scores : MonoBehaviour
{
    NetworkClient myClient;

    public class MyMsgType {
        public static short Score = MsgType.Highest + 1;
    };

    public class ScoreMessage : MessageBase
    {
        public int score;
        public Vector3 scorePos;
        public int lives;
    }

    public void SendScore(int score, Vector3 scorePos, int lives)
    {
        ScoreMessage msg = new ScoreMessage();
        msg.score = score;
        msg.scorePos = scorePos;
        msg.lives = lives;

        NetworkServer.SendToAll(MyMsgType.Score, msg);
    }

    // Create a client and connect to the server port
    public void SetupClient()
    {
        myClient = new NetworkClient();
        myClient.RegisterHandler(MsgType.Connect, OnConnected);
        myClient.RegisterHandler(MyMsgType.Score, OnScore);
        myClient.Connect("127.0.0.1", 4444);
    }

    public void OnScore(NetworkMessage netMsg)
    {
        ScoreMessage msg = netMsg.ReadMessage&lt;ScoreMessage&gt;();
        Debug.Log("OnScoreMessage " + msg.score);
    }

    public void OnConnected(NetworkMessage netMsg)
    {
        Debug.Log("Connected to server");
    }
}
</code></pre>

<p>Note that there is no serialization code for the ScoreMessage class in this source code for example. The body of the serialization functions is automatically generated for this class.</p>

<h1>Error Message Class</h1>

<p>Thre is also a ErrorMessage class that is derived from MessageBase. This class is passed to error callbacks on clients and servers.</p>

<p>The errorCode in the ErrorMessage class corresponds to the Networking.NetworkError enumeration.</p>

<pre><code>class MyClient
{
    NetworkClient client;
    
    void Start()
    {
        client = new NetworkClient();
        client.RegisterHandler(MsgType.Error, OnError);
    }
    
    void OnError(NetworkMessage netMsg)
    {
        var errorMsg = netMsg.ReadMessage&lt;ErrorMessage&gt;();
        Debug.Log("Error:" + errorMsg.errorCode);
    }
}
</code></pre>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="NetworkBehaviourCallbacks.html"></a></span><div class="tip">NetworkBehaviour 回调</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UNetDiscovery.html"></a></span><div class="tip">Local Discovery</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2017 Unity Technologies. Publication 5.6</div>
<div class="menu">
<a href="http://unity3d.com/learn">Tutorials</a><a href="http://answers.unity3d.com">Community Answers</a><a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a><a href="http://forum.unity3d.com">Forums</a><a href="http://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
