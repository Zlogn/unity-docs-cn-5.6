<!DOCTYPE html><html class="no-js" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<meta property="og:title" content="Custom Spawn Functions - Unity 手册">
<title>Custom Spawn Functions - Unity 手册</title>
<meta name="description" content="The default behaviour of creating spawned objects from prefabs on the client can be customized by using spawn handler functions. This way you have full control of how you spawn the object as well as how you un-spawn it. You can register functions to spawn and un-spawn client objects with ClientScene.RegisterSpawnHandler. The server creates objects directly and then spawn them on the clients though this functionality. This function takes the asset ID of the object and two function delegates, one to handle creating objects on the client and one to handler destroying objects on the client. The asset ID can be a dynamic one or just the asset ID found on the prefab object you want to spawn (if you have one).">
<meta property="og:description" content="The default behaviour of creating spawned objects from prefabs on the client can be customized by using spawn handler functions. This way you have full control of how you spawn the object as well as how you un-spawn it. You can register functions to spawn and un-spawn client objects with ClientScene.RegisterSpawnHandler. The server creates objects directly and then spawn them on the clients though this functionality. This function takes the asset ID of the object and two function delegates, one to handle creating objects on the client and one to handler destroying objects on the client. The asset ID can be a dynamic one or just the asset ID found on the prefab object you want to spawn (if you have one).">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFiles/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script>
      var docs_type = 'Manual';
      var lang = 'cn';
      var page = 'UNetCustomSpawning';
      if(!page) page = 'index';
      var version = '560';
      var docs_versions = [{version: '2020.1',version_string: '2020.1'},{version: '2019.3',version_string: '2019.3'},{version: '2019.2',version_string: '2019.2'},{version: '2019.1',version_string: '2019.1'},{version: '2018.4',version_string: '2018.4'},{version: '2018.3',version_string: '2018.3'},{version: '2018.2',version_string: '2018.2'},{version: '2018.1',version_string: '2018.1'},{version: '2017.4',version_string: '2017.4'},{version: '2017.3',version_string: '2017.3'},{version: '2017.2',version_string: '2017.2'},{version: '2017.1',version_string: '2017.1'},{version: '5.6',version_string: '560'},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
<link rel="canonical" href="https://docs.unity3d.com/cn/560/Manual/UNetCustomSpawning.html">
<link rel="alternate" href="https://docs.unity3d.com/en/560/Manual/UNetCustomSpawning.html" hreflang="en">
<link rel="alternate" href="https://docs.unity3d.com/ja/560/Manual/UNetCustomSpawning.html" hreflang="ja">
<link rel="alternate" href="https://docs.unity3d.com/es/560/Manual/UNetCustomSpawning.html" hreflang="es">
<link rel="alternate" href="https://docs.unity3d.com/kr/560/Manual/UNetCustomSpawning.html" hreflang="ko">
<link rel="alternate" href="https://docs.unity3d.com/ru/560/Manual/UNetCustomSpawning.html" hreflang="ru">
<link rel="alternate" href="https://docs.unity3d.com/560/Documentation/Manual/UNetCustomSpawning.html" hreflang="x-default">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="http://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="搜索手册..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>5.6</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/UNetCustomSpawning.html">2020.1</a></li>
<li><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/UNetCustomSpawning.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/UNetCustomSpawning.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/UNetCustomSpawning.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/UNetCustomSpawning.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/UNetCustomSpawning.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/UNetCustomSpawning.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/UNetCustomSpawning.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/UNetCustomSpawning.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/UNetCustomSpawning.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/UNetCustomSpawning.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/UNetCustomSpawning.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/cn/560/Manual/UNetCustomSpawning.html">5.6</a></li>
</ul></div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">语言:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/560/Documentation/Manual/UNetCustomSpawning.html">English</a></li>
<li><a data-lang="ja" href="/ja/560/Manual/UNetCustomSpawning.html">日本語</a></li>
<li><a data-lang="es" href="/es/560/Manual/UNetCustomSpawning.html">Español</a></li>
<li><a data-lang="kr" href="/kr/560/Manual/UNetCustomSpawning.html">한국어</a></li>
<li><a data-lang="ru" href="/ru/560/Manual/UNetCustomSpawning.html">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>手册</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>5.6</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/UNetCustomSpawning.html">2020.1</a></li>
<li><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/UNetCustomSpawning.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/UNetCustomSpawning.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/UNetCustomSpawning.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/UNetCustomSpawning.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/UNetCustomSpawning.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/UNetCustomSpawning.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/UNetCustomSpawning.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/UNetCustomSpawning.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/UNetCustomSpawning.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/UNetCustomSpawning.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/UNetCustomSpawning.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/cn/560/Manual/UNetCustomSpawning.html">5.6</a></li>
</ul></div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual (5.6)</a></li>
<li><a href="UNet.html">多玩家和联网</a></li>
<li><a href="UNetOverview.html">Networking Overview</a></li>
<li><a href="UNetUsingHLAPI.html">The High Level API</a></li>
<li>Custom Spawn Functions</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UNetSpawning.html"></a></span><div class="tip">Object Spawning</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UNetStateSync.html"></a></span><div class="tip">状态同步</div>
</div>
</div></div>
<h2>Custom Spawn Functions</h2>

<p>The default behaviour of creating spawned objects from prefabs on the client can be customized by using spawn handler functions. This way you have full control of how you spawn the object as well as how you un-spawn it. You can register functions to spawn and un-spawn client objects with <a href="../ScriptReference/Networking.ClientScene.RegisterSpawnHandler.html">ClientScene.RegisterSpawnHandler</a>. The server creates objects directly and then spawn them on the clients though this functionality. This function takes the asset ID of the object and two function delegates, one to handle creating objects on the client and one to handler destroying objects on the client. The asset ID can be a dynamic one or just the asset ID found on the prefab object you want to spawn (if you have one). </p>

<p>The spawn / un-spawner need to have this object signature, this is defined in the high level API.</p>

<pre><code>// Handles requests to spawn objects on the client
public delegate GameObject SpawnDelegate(Vector3 position, NetworkHash128 assetId);

// Handles requests to unspawn objects on the client
public delegate void UnSpawnDelegate(GameObject spawned);
</code></pre>

<p>The asset ID passed to the spawn function can be found on <a href="../ScriptReference/Networking.NetworkIdentity-assetId.html">NetworkIdentity.assetId</a> for prefabs, where it is populated automatically. The registration for a dynamic asset ID is handled liked his:</p>

<pre><code>// generate a new unique assetId 
NetworkHash128 creatureAssetId = NetworkHash128.Parse("e2656f");

// register handlers for the new assetId
ClientScene.RegisterSpawnHandler(creatureAssetId, SpawnCreature, UnSpawnCreature);

// get assetId on an existing prefab
NetworkHash128 bulletAssetId = bulletPrefab.GetComponent&lt;NetworkIdentity&gt;().assetId;

// register handlers for an existing prefab you'd like to custom spawn
ClientScene.RegisterSpawnHandler(bulletAssetId, SpawnBullet, UnSpawnBullet);

// spawn a bullet - SpawnBullet will be called on client.
NetworkServer.Spawn(gameObject, creatureAssetId);
</code></pre>

<p>The spawn functions themselves are implemented with the delegate signature, here is the bullet spawner but the SpawnCreature would look the same but have different spawn logic</p>

<pre><code>public GameObject SpawnBullet(Vector3 position, NetworkHash128 assetId)
{
    return (GameObject)Instantiate(m_BulletPrefab, position, Quaternion.identity);
}
public void UnSpawnBullet(GameObject spawned)
{
    Destroy(spawned);
}
</code></pre>

<p>When using custom spawn functions, it is sometimes useful to be able to unspawn objects without destroying them. This can be done by calling <a href="../ScriptReference/Networking.NetworkServer.UnSpawn.html">NetworkServer.UnSpawn</a>. This causes a message to be sent to clients to un-spawn the object, so that the custom un-spawn function will be called on the clients. The object is not destroyed when this function is called.</p>

<p>Note that on the host, object are not spawned for the local client as they already exist on the server. So no spawn handler functions will be called.</p>

<h2>Setting up an object pool with custom spawn handlers</h2>

<p>Here is an example of how you might set up a very simple object pooling system with custom spawn handlers. Spawning and unspawning then just puts objects in or out of the pool.</p>

<pre><code>using UnityEngine;
using UnityEngine.Networking;
using System.Collections;

public class SpawnManager : MonoBehaviour
{
    public int m_ObjectPoolSize = 5;
    public GameObject m_Prefab;
    public GameObject[] m_Pool;

    public NetworkHash128 assetId { get; set; }
    
    public delegate GameObject SpawnDelegate(Vector3 position, NetworkHash128 assetId);
    public delegate void UnSpawnDelegate(GameObject spawned);

    void Start()
    {
        assetId = m_Prefab.GetComponent&lt;NetworkIdentity&gt; ().assetId;
        m_Pool = new GameObject[m_ObjectPoolSize];
        for (int i = 0; i &lt; m_ObjectPoolSize; ++i)
        {
            m_Pool[i] = (GameObject)Instantiate(m_Prefab, Vector3.zero, Quaternion.identity);
            m_Pool[i].name = "PoolObject" + i;
            m_Pool[i].SetActive(false);
        }
        
        ClientScene.RegisterSpawnHandler(assetId, SpawnObject, UnSpawnObject);
    }

    public GameObject GetFromPool(Vector3 position)
    {
        foreach (var obj in m_Pool)
        {
            if (!obj.activeInHierarchy)
            {
                Debug.Log("Activating object " + obj.name + " at " + position);
                obj.transform.position = position;
                obj.SetActive (true);
                return obj;
            }
        }
        Debug.LogError ("Could not grab object from pool, nothing available");
        return null;
    }
    
    public GameObject SpawnObject(Vector3 position, NetworkHash128 assetId)
    {
        return GetFromPool(position);
    }
    
    public void UnSpawnObject(GameObject spawned)
    {
        Debug.Log ("Re-pooling object " + spawned.name);
        spawned.SetActive (false);
    }
}
</code></pre>

<p>To use this manager do the following</p>

<ul>
<li>This works in a scene like the one in the <a href="UNetSetup.html">Getting Started</a> guide.</li>
<li>Create a new empty game object called “SpawnManager”</li>
<li>Create a SpawnManager script for the code above and add that to a new SpawnManager object</li>
<li>Drag a prefab you want to spawn multiple times to the prefab field and set the size (default is 5).</li>
<li>Set up a reference to the spawn manager in the player movement script</li>
</ul>

<pre><code>SpawnManager spawnManager;

void Start()
{
    spawnManager = GameObject.Find("SpawnManager").GetComponent&lt;SpawnManager&gt; ();
}
</code></pre>

<ul>
<li>The player logic could contain something like this to move and fire bullets</li>
</ul>

<pre><code>void Update()
{
    if (!isLocalPlayer)
        return;
    
    var x = Input.GetAxis("Horizontal")*0.1f;
    var z = Input.GetAxis("Vertical")*0.1f;
    
    transform.Translate(x, 0, z);

    if (Input.GetKeyDown(KeyCode.Space))
    {
        // Command function is called on the client, but invoked on the server
        CmdFire();
    }
}
</code></pre>

<ul>
<li>In the fire logic on the player, make it use the object pool</li>
</ul>

<pre><code>[Command]
void CmdFire()
{
    // Set up bullet on server
    var bullet = spawnManager.GetFromPool(transform.position + transform.forward);  
    bullet.GetComponent&lt;Rigidbody&gt;().velocity = transform.forward*4;
    
    // spawn bullet on client, custom spawn handler will be called
    NetworkServer.Spawn(bullet, spawnManager.assetId);
    
    // when the bullet is destroyed on the server it wil automatically be destroyed on clients
    StartCoroutine (Destroy (bullet, 2.0f));
}

public IEnumerator Destroy(GameObject go, float timer)
{
    yield return new WaitForSeconds (timer);
    spawnManager.UnSpawnObject(go);
    NetworkServer.UnSpawn(go);
}
</code></pre>

<p>The automatic destruction shows how the objects are returned to the pool and re-used when you fire again.</p>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UNetSpawning.html"></a></span><div class="tip">Object Spawning</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UNetStateSync.html"></a></span><div class="tip">状态同步</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2017 Unity Technologies. Publication 5.6</div>
<div class="menu">
<a href="http://unity3d.com/learn">教程</a><a href="http://answers.unity3d.com">社区答案</a><a href="https://support.unity3d.com/hc/en-us">知识库</a><a href="http://forum.unity3d.com">论坛</a><a href="http://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
