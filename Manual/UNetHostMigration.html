<!DOCTYPE html><html class="no-js" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<meta property="og:title" content="主机迁移 - Unity 手册">
<title>主机迁移 - Unity 手册</title>
<meta property="og:image" content="https://docs.unity3d.com/cn/5.6/uploads/Main/NetworkMigrationManagerInspector.png">
<meta name="description" content="In a multiplayer network game without a dedicated server, one of the peers in the game acts as the center of authority for the game. This peer is called the &amp;#8220;host&amp;#8221;. It runs a server and a &amp;#8220;local client&amp;#8221;, while the other peers each run a &amp;#8220;remote client&amp;#8221;.">
<meta property="og:description" content="In a multiplayer network game without a dedicated server, one of the peers in the game acts as the center of authority for the game. This peer is called the &amp;#8220;host&amp;#8221;. It runs a server and a &amp;#8220;local client&amp;#8221;, while the other peers each run a &amp;#8220;remote client&amp;#8221;.">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFiles/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script>
      var docs_type = 'Manual';
      var lang = 'cn';
      var page = 'UNetHostMigration';
      if(!page) page = 'index';
      var version = '560';
      var docs_versions = [{version: '2020.1',version_string: '2020.1'},{version: '2019.3',version_string: '2019.3'},{version: '2019.2',version_string: '2019.2'},{version: '2019.1',version_string: '2019.1'},{version: '2018.4',version_string: '2018.4'},{version: '2018.3',version_string: '2018.3'},{version: '2018.2',version_string: '2018.2'},{version: '2018.1',version_string: '2018.1'},{version: '2017.4',version_string: '2017.4'},{version: '2017.3',version_string: '2017.3'},{version: '2017.2',version_string: '2017.2'},{version: '2017.1',version_string: '2017.1'},{version: '5.6',version_string: '560'},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
<link rel="canonical" href="https://docs.unity3d.com/cn/560/Manual/UNetHostMigration.html">
<link rel="alternate" href="https://docs.unity3d.com/en/560/Manual/UNetHostMigration.html" hreflang="en">
<link rel="alternate" href="https://docs.unity3d.com/ja/560/Manual/UNetHostMigration.html" hreflang="ja">
<link rel="alternate" href="https://docs.unity3d.com/es/560/Manual/UNetHostMigration.html" hreflang="es">
<link rel="alternate" href="https://docs.unity3d.com/kr/560/Manual/UNetHostMigration.html" hreflang="ko">
<link rel="alternate" href="https://docs.unity3d.com/ru/560/Manual/UNetHostMigration.html" hreflang="ru">
<link rel="alternate" href="https://docs.unity3d.com/560/Documentation/Manual/UNetHostMigration.html" hreflang="x-default">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="http://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="搜索手册..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>5.6</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/UNetHostMigration.html">2020.1</a></li>
<li><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/UNetHostMigration.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/UNetHostMigration.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/UNetHostMigration.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/UNetHostMigration.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/UNetHostMigration.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/UNetHostMigration.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/UNetHostMigration.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/UNetHostMigration.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/UNetHostMigration.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/UNetHostMigration.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/UNetHostMigration.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/cn/560/Manual/UNetHostMigration.html">5.6</a></li>
</ul></div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">语言:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/560/Documentation/Manual/UNetHostMigration.html">English</a></li>
<li><a data-lang="ja" href="/ja/560/Manual/UNetHostMigration.html">日本語</a></li>
<li><a data-lang="es" href="/es/560/Manual/UNetHostMigration.html">Español</a></li>
<li><a data-lang="kr" href="/kr/560/Manual/UNetHostMigration.html">한국어</a></li>
<li><a data-lang="ru" href="/ru/560/Manual/UNetHostMigration.html">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>手册</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>5.6</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/UNetHostMigration.html">2020.1</a></li>
<li><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/UNetHostMigration.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/UNetHostMigration.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/UNetHostMigration.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/UNetHostMigration.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/UNetHostMigration.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/UNetHostMigration.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/UNetHostMigration.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/UNetHostMigration.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/UNetHostMigration.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/UNetHostMigration.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/UNetHostMigration.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/cn/560/Manual/UNetHostMigration.html">5.6</a></li>
</ul></div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual (5.6)</a></li>
<li><a href="UNet.html">多玩家和联网</a></li>
<li><a href="UNetOverview.html">Networking Overview</a></li>
<li><a href="UNetUsingHLAPI.html">The High Level API</a></li>
<li>主机迁移</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UNetClientServer.html"></a></span><div class="tip">Network Clients and Servers</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UNetUsingTransport.html"></a></span><div class="tip">Using the Transport Layer API</div>
</div>
</div></div>
<h1>主机迁移</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>In a multiplayer network game without a dedicated server, one of the peers in the game acts as the center of authority for the game. This peer is called the “host”. It runs a server and a “local client”, while the other peers each run a “remote client”.</p>

<p>If the host of a game is lost, then the game cannot continue. The host could be lost because the player left, the host process was killed or crashed, the host’s machine was shut down, or because the network connection of the host was lost.</p>

<p>The “Host Migration” feature allows one of the remote clients to become the new host, so that the multiplayer game can continue.</p>

<h1>How it works</h1>

<p>During a multiplayer game with host migration enabled, the addresses of the peers will be distributed to the peers in the game. When the host is lost, one peer can become the new host. The other peers then connect to the new host and the game can continue.</p>

<p>The new NetworkMigrationManager component can be dropped into a multiplayer game that uses the Unity Networking HLAPI, and it allows the game to continue with a new host after the original host is lost. Below is a screenshot of the NetworkMigrationManager in the editor inspector. It shows the current migration state.</p>

<figure>
<img src="../uploads/Main/NetworkMigrationManagerInspector.png" alt="Network Migration Manager 组件">
<figcaption>Network Migration Manager 组件</figcaption>
</figure>

<p>There is a simple user interface provided by the NetworkMigrationManager, similar to the <a href="UNetManager.html">NetworkManagerHUD</a>. This user interface is intended for testing and prototyping; a real game would implement a custom user interface for host migration, and probably custom logic - possibly choosing the new host automatically without requiring input from the user.</p>

<figure>
<img src="../uploads/Main/NetworkMigrationManagerHUD.png" alt="Network Migration Manager 原型设计 HUD">
<figcaption>Network Migration Manager 原型设计 HUD</figcaption>
</figure>

<p>Even though the migration may have occurred because the old host lost connection or quite the game, it is possible for the old host of the game to rejoin the game as a client on the new host.</p>

<p>The state of SyncVars and SyncLists on all networked objects in the scene are maintained during a host migration. This also applies to custom serialized data for objects.</p>

<p>All of the player objects in the game are disabled when the host is lost. Then, when the other clients rejoin the new game on the new host, the corresponding players for those clients are re-enabled on the host, and respawned on the other clients. So no player state data is lost during a host migration.</p>

<p><strong>NOTE</strong>: Only data that is available to clients will be preserved during a host migration. If there is data that is only on the server, then it will not be available to the client that becomes the new host. So any data on the host that is not stored in SyncVars or SyncLists will not be available after a host migration.</p>

<p>The callback function <a href="../ScriptReference/Networking.NetworkBehaviour.OnStartServer.html">OnStartServer</a> is invoked for all networked objects when the client becomes a new host.</p>

<p>On the new host, the NetworkMigrationManager uses the function <a href="../ScriptReference/Networking.NetworkMigrationManager.BecomeNewHost.html">BecomeNewHost</a> to construct a networked server scene from the state in the current ClientScene.</p>

<p>The peers in a game with host migration enabled are identified by their <code>connectionId</code> on the server. When a client reconnects to the new host of a game, this connectionId is passed to the new host so that it can match this client with the client that was connected to the old host. This Id is set on the ClientScene as the “reconnectId”.</p>

<h1>Non-Player Objects</h1>

<p>Non-player objects with client authority are also handled by host migration. The objects owned by each client are disabled and re-enabled the same way that player objects are.</p>

<h1>Identifying Peers</h1>

<p>Before the host is lost, all the peers are connected to the host. They each have a unique connectionId on the host - this is called the “oldConnectionId” in the context of host migration. </p>

<p>When a new host is chosen and the peers reconnect to it, they supply their “oldConnectionId” to identify which peer they are. This allows the new host to match this reconnecting client to the corresponding player object.</p>

<p>The old host uses a special oldConnectionId of zero to reconnect - since it did not have a connection to the old host, it WAS the old host. There is a constant ClientScene.ReconnectIdHost for this.</p>

<p>When using the built-in user interface, the oldConnectionId is set automatically. It can be set manually using <a href="../ScriptReference/Networking.NetworkMigrationManager.Reset.html">NetworkMigrationManager.Reset</a> or <a href="../ScriptReference/Networking.ClientScene.SetReconnectId.html">ClientScene.SetReconnectId</a>.</p>

<h1>Host Migration Flow</h1>

<ol>
<li><p>MachineA hosts a game with host-migration enabled</p></li>
<li>MachineB starts a client and joins the game with host-migration enabled

<ul>
<li>MachineB is told about peers (MachineA–0, and self (MachineB)–1)</li>
</ul>
</li>
<li>MachineC starts a client and joins the game with host-migration enabled

<ul>
<li>MachineC is told about peers (MachineA–0, MachineB–1, and self (MachineC)–2)</li>
</ul>
</li>
<li><p>MachineA is lost, so the host is lost</p></li>
<li>MachineB gets disconnect from host

<ol>
<li>MachineB callback function is invoked on MigrationManager on client</li>
<li>MachineB player objects for all players are disabled</li>
<li>MachineB stay in online scene</li>
</ol>
</li>
<li>MachineB 使用实用函数来挑选新主机，选取自身作为新主机

<ol>
<li>MachineB calls BecomeNewHost()</li>
<li>MachineB 开始监听</li>
<li>MachineB player object for self is reactivated</li>
<li>MachineB 的玩家现在已恢复自己原来的全部游戏状态</li>
</ol>
</li>
<li>MachineC 与主机断开连接

<ol>
<li>MachineC callback function is invoked on MigrationManager on client</li>
<li>MachineC player objects for all players are disabled</li>
<li>MachineC stay in online scene</li>
</ol>
</li>
<li>MachineC 使用实用函数来挑选新主机，选取 MachineB

<ul>
<li>MachineC 重新连接到新主机</li>
</ul>
</li>
<li>MachineB 接收来自 MachineC 的连接

<ol>
<li>MachineC send reconnect message with oldConnectionId (instead of AddPlayer message)</li>
<li>MigrationManager 在服务器上调用回调函数</li>
<li>MachineB uses oldConnectionId to find the disabled player object for that player and re-adds it with ReconnectPlayerForConnection()</li>
<li>player object is re-spawned for MachineC</li>
<li>MachineC 的玩家现在已恢复自己原来的全部游戏状态</li>
</ol>
</li>
<li>MachineA 恢复（旧主机）

<ol>
<li>MachineA uses utility function to pick the new host, picks MachineB</li>
<li>MachineA “reconnects” to MachineB</li>
</ol>
</li>
<li><p>MachineB 接收来自 MachineA 的连接</p></li>
<li>MachineA 以等于零的 oldConnectionId 发送重新连接消息

<ol>
<li>callback function is invoked on MigrationManager on server (MachineB)</li>
<li>MachineB uses oldConnectionId to find the disabled player object for that player and re-adds it with ReconnectPlayerForConnection()</li>
<li>player object is re-spawned for MachineA</li>
<li>MachineA 的玩家现在已恢复自己原来的全部游戏状态</li>
</ol>
</li>
</ol>

<h1>Callback Functions</h1>

<p>Callback functions on the NetworkHostMigrationManager</p>

<pre><code>// called on client after the connection to host is lost. controls whether to switch scenes
protected virtual void OnClientDisconnectedFromHost(
    NetworkConnection conn, 
    out SceneChangeOption sceneChange)

// called on host after the host is lost. host MUST change scenes
protected virtual void OnServerHostShutdown()

// called on new host (server) when a client from the old host re-connects a player
protected virtual void OnServerReconnectPlayer(
    NetworkConnection newConnection, 
    GameObject oldPlayer, 
    int oldConnectionId, 
    short playerControllerId)

// called on new host (server) when a client from the old host re-connects a player
protected virtual void OnServerReconnectPlayer(
    NetworkConnection newConnection, 
    GameObject oldPlayer, 
    int oldConnectionId, 
    short playerControllerId, 
    NetworkReader extraMessageReader)

// called on new host (server) when a client from the old host re-connects a non-player object
protected virtual void OnServerReconnectObject(
    NetworkConnection newConnection, 
    GameObject oldObject, 
    int oldConnectionId)

// called on both host and client when the set of peers is updated
protected virtual void OnPeersUpdated(
    PeerListMessage peers)

// utility function called by the default UI on client after connection to host was lost, to pick a new host.
public virtual bool FindNewHost(
    out NetworkSystem.PeerInfoMessage newHostInfo, 
    out bool youAreNewHost)

// called when the authority of a non-player object changes
protected virtual void OnAuthorityUpdated(
    GameObject go,
    int connectionId,
    bool authorityState)
</code></pre>

<h1>约束</h1>

<p>Data that is only present on the server (the host) will be lost when the host is disconnected. For games to be able to perform host migration correctly, important data must be distributed to the clients, not held secretly on the server.</p>

<p>这种情况适用于直接连接的游戏。需要执行额外的工作才能与 Matchmaker 和 Relay Server 一起工作。</p>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UNetClientServer.html"></a></span><div class="tip">Network Clients and Servers</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UNetUsingTransport.html"></a></span><div class="tip">Using the Transport Layer API</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2017 Unity Technologies. Publication 5.6</div>
<div class="menu">
<a href="http://unity3d.com/learn">教程</a><a href="http://answers.unity3d.com">社区答案</a><a href="https://support.unity3d.com/hc/en-us">知识库</a><a href="http://forum.unity3d.com">论坛</a><a href="http://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
